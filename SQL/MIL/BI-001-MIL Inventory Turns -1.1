-- ON HAND IN WH51 ON DSN=MILPRODBI
SELECT a.ITNBR,a.HOUSE, a.ITCLS, a.MOHTQ, b.RPAMVA "UP($USD)",
(CASE 
        WHEN a.ITCLS LIKE 'TAF%' THEN 'RP'
        WHEN a.ITCLS IN ('PACS') THEN 'UnKits'
        WHEN a.ITCLS LIKE 'Z%' AND a.ITCLS LIKE '%K' THEN 'UnKits'
        WHEN a.ITCLS IN ('ZACM','ZASU','ZMLH','ZMLR','ZUSR','ZUSU','ZVUC','ZXUC','ZUSU','ZUMU','ZAMU','ZASM','ZASR','ZDMA','ZMUC','ZSUS','ZUMS','ZUSM','ZVMA','ZVUS','ZXLH','ZXLM','ZXLR','ZXMS','ZXMU') THEN 'UPH'
        WHEN a.ITCLS IN ('ZDAA','ZDAY','ZVAA','ZDAB','ZDAW','ZDYB','ZDBC','ZABC','ZECD') THEN 'CG'
        WHEN a.ITCLS IN ('ZKIS') THEN 'Bedding'		
        WHEN a.ITCLS IN ('WPLS') THEN 'Plastics'
        WHEN a.ITCLS IN ('WVBC','WVCS') THEN 'Foundation'		
        WHEN a.ITCLS IN ('PANL') THEN 'Panel'
        WHEN a.ITCLS IN ('ZKIZ') THEN 'ZipperCover'
        WHEN a.ITCLS IN ('BBFR','WVHC') THEN 'Verona'		
        WHEN a.ITCLS NOT LIKE 'Z%' THEN 'Raw'
        ELSE 'Check' END) AS Product,
(CASE 
    WHEN b.RPAMVA IS NULL AND a.ITCLS NOT LIKE 'Z%' THEN 0
	WHEN b.RPAMVA IS NULL AND a.ITCLS LIKE 'Z%' THEN a.MOHTQ*50
	ELSE a.MOHTQ*b.RPAMVA END) as "AMT($USD)"
FROM 
(SELECT T1.ITNBR,T1.HOUSE, T1.ITCLS, T1.MOHTQ, T1.WHSLC, T2.ITDSC    
FROM AMFLIBL.ITEMBL T1, AMFLIBL.ITMRVA T2, AMFLIBL.WHSMST T3 
WHERE  T2.ITCLS = T1.ITCLS AND T2.ITNBR = T1.ITNBR AND T2.STID = T3.STID AND T1.HOUSE = T3.WHID AND ((T1.HOUSE='51') AND (T1.MOHTQ<>0))
ORDER BY T1.ITNBR) as a
LEFT JOIN 
(
-- MIL UNIT PRICE CREATED ON Feb.15.2022 BY JIMSHEN
SELECT b1.RPAITX, MAX(b1.RPAMVA) as RPAMVA
FROM 
(SELECT x.RPAITX, x.ITCLS, x.RPAMVA, x.RPBLDT, x.RPZ0D7
FROM
(
((SELECT a.RPAITX,(CASE WHEN a.RPBRCD IN ('VND') THEN a.RPAMVA/23090 ELSE a.RPAMVA END) AS RPAMVA,a.RPBLDT,a.RPZ0D7, T2.ITCLS
FROM AMFLIBL.ITMFPR a 
LEFT JOIN AMFLIBL.ITMRVA T2 ON a.RPAITX=T2.ITNBR AND a.RPZ0D7 = T2.STID 
WHERE a.RPZ0D7 = '51' AND a.RPAITX||a.RPZ0D7||a.RPBLDT IN (SELECT a.RPAITX||a.RPZ0D7||MAX(a.RPBLDT) RPBLDT FROM AMFLIBL.ITMFPR a  WHERE a.RPZ0D7 = '51' GROUP BY a.RPAITX,a.RPZ0D7)) 
UNION ALL
(SELECT t1.ITNO1G, t1.UCCT1G/23090 AS RPAMVA, t1.CCDT1G, t1.STID1G, t1.STID1G FROM AMFLIBL.ITMPRB t1))
UNION ALL
(SELECT t1.ITNBR, t1.LCOST/23090 AS RPAMVA, t1.LDQOH, t1.HOUSE, t1.ITCLS FROM AMFLIBL.ITEMBL t1))AS x
ORDER BY x.RPAITX, x.RPAMVA ASC) b1
GROUP BY b1.RPAITX
) as b 
ON a.ITNBR = b.RPAITX 




