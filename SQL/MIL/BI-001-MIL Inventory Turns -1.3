-- WH Trx Summary in qty and amount  DSN=MILPRODBI
SELECT X.ITNBR, X.HOUSE, X.ITCLS,X.WEEK,X.YEAR,X.YEAR*100+X.WEEK AS "YearWeek",X.TRQTY,Y.PAMNT "UP($USD)",
(CASE 
        WHEN X.ITCLS LIKE 'TAF%' THEN 'RP'
        WHEN X.ITCLS IN ('PACS') THEN 'UnKits'
        WHEN X.ITCLS LIKE 'Z%' AND X.ITCLS LIKE '%K' THEN 'UnKits'
        WHEN X.ITCLS IN ('ZACM','ZASU','ZMLH','ZMLR','ZUSR','ZUSU','ZVUC','ZXUC','ZUSU','ZUMU','ZAMU','ZASM','ZASR','ZDMA','ZMUC','ZSUS','ZUMS','ZUSM','ZVMA','ZVUS','ZXLH','ZXLM','ZXLR','ZXMS','ZXMU') THEN 'UPH'
        WHEN X.ITCLS IN ('ZDAA','ZDAY','ZVAA','ZDAB','ZDAW','ZDYB','ZDBC','ZABC','ZECD') THEN 'CG'
        WHEN X.ITCLS IN ('ZKIS') THEN 'Bedding'		
        WHEN X.ITCLS IN ('WPLS') THEN 'Plastics'
        WHEN X.ITCLS IN ('WVBC','WVCS') THEN 'Foundation'		
        WHEN X.ITCLS IN ('PANL') THEN 'Panel'
        WHEN X.ITCLS IN ('ZKIZ') THEN 'ZipperCover'
        WHEN X.ITCLS IN ('BBFR','WVHC') THEN 'Verona'		
        WHEN X.ITCLS NOT LIKE 'Z%' THEN 'Raw'
        ELSE 'Check' END) AS Product,
(CASE 
		WHEN X.TCODE IN ('RP','PQ','RM','RS','RC','IA','LA') THEN 'IN'
		WHEN X.TCODE IN ('SA','IP','IS','VR','IU','SC','SM','SP','SS') THEN 'OUT'
		ELSE 'CHECK' END ) as "TYPE",
(CASE 
    WHEN Y.PAMNT IS NULL AND X.ITCLS NOT LIKE 'Z%' THEN 0
	WHEN Y.PAMNT IS NULL AND X.ITCLS LIKE 'Z%' THEN X.TRQTY*50
	ELSE X.TRQTY*Y.PAMNT END) as "AMT($USD)"	
FROM
(     
SELECT T1.TCODE, T1.ITNBR, T1.HOUSE, T2.ITCLS, 
WEEK(DATE('20'||SUBSTR(CHAR(T1.UPDDT),2,2)||'-'||SUBSTR(CHAR(T1.UPDDT),4,2)||'-'||SUBSTR(CHAR(T1.UPDDT),6,2))) AS WEEK,
YEAR(DATE('20'||SUBSTR(CHAR(T1.UPDDT),2,2)||'-'||SUBSTR(CHAR(T1.UPDDT),4,2)||'-'||SUBSTR(CHAR(T1.UPDDT),6,2))) AS YEAR,
SUM(T1.TRQTY) TRQTY
FROM AMFLIBL.IMHIST T1, AMFLIBL.ITMRVA T2, AMFLIBL.WHSMST T3
WHERE T2.ITNBR = T1.ITNBR AND T2.STID = T3.STID AND T1.HOUSE = T3.WHID AND T1.HOUSE='51' 
AND T1.UPDDT BETWEEN '1201201' AND CHAR('1'||VARCHAR_FORMAT(current date,'YYMMDD'))
AND T1.TRQTY<>0 AND T1.TCODE IN ('RP','PQ','RM','RS','RC','IA','LA','SA','IP','IS','VR','IU','SC','SM','SP','SS') 
GROUP BY  T1.TCODE, T1.ITNBR, T1.HOUSE, T2.ITCLS, 
WEEK(DATE('20'||SUBSTR(CHAR(T1.UPDDT),2,2)||'-'||SUBSTR(CHAR(T1.UPDDT),4,2)||'-'||SUBSTR(CHAR(T1.UPDDT),6,2))),
YEAR(DATE('20'||SUBSTR(CHAR(T1.UPDDT),2,2)||'-'||SUBSTR(CHAR(T1.UPDDT),4,2)||'-'||SUBSTR(CHAR(T1.UPDDT),6,2)))
ORDER BY T1.ITNBR 
) AS X 
LEFT JOIN (
-- MIL UNIT PRICE CREATED ON Feb.15.2022 BY JIMSHEN
SELECT b1.RPAITX AS PITEM, MAX(b1.RPAMVA) as PAMNT
FROM 
(SELECT x.RPAITX, x.ITCLS, x.RPAMVA, x.RPBLDT, x.RPZ0D7
FROM
(
((SELECT a.RPAITX,(CASE WHEN a.RPBRCD IN ('VND') THEN a.RPAMVA/23090 ELSE a.RPAMVA END) AS RPAMVA,a.RPBLDT,a.RPZ0D7, T2.ITCLS
FROM AMFLIBL.ITMFPR a 
LEFT JOIN AMFLIBL.ITMRVA T2 ON a.RPAITX=T2.ITNBR AND a.RPZ0D7 = T2.STID 
WHERE a.RPZ0D7 = '51' AND a.RPAITX||a.RPZ0D7||a.RPBLDT IN (SELECT a.RPAITX||a.RPZ0D7||MAX(a.RPBLDT) RPBLDT FROM AMFLIBL.ITMFPR a  WHERE a.RPZ0D7 = '51' GROUP BY a.RPAITX,a.RPZ0D7)) 
UNION ALL
(SELECT t1.ITNO1G, t1.UCCT1G/23090 AS RPAMVA, t1.CCDT1G, t1.STID1G, t1.STID1G FROM AMFLIBL.ITMPRB t1))
UNION ALL
(SELECT t1.ITNBR, t1.LCOST/23090 AS RPAMVA, t1.LDQOH, t1.HOUSE, t1.ITCLS FROM AMFLIBL.ITEMBL t1))AS x
ORDER BY x.RPAITX, x.RPAMVA ASC) b1
GROUP BY b1.RPAITX
) as Y 
ON X.ITNBR = Y.PITEM

