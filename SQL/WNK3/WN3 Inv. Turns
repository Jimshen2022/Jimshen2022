
-- WH Trx Summary in qty and amount  DSN=WANEKBIA
SELECT a.HOUSE, a.Week, a.YEAR, a.Product, a."TYPE", SUM(a.TRQTY) TRQTY, SUM(a."AMT($USD)") AS "AMT($USD)"
FROM
(
SELECT X.ITNBR, X.HOUSE, X.ITCLS,X.WEEK,X.YEAR,X.TRQTY,Y.RPAMVA "UP($USD)",
(CASE 
    WHEN X.ITCLS NOT LIKE 'Z%' THEN 'RP'
	WHEN X.ITCLS LIKE 'Z%' AND X.ITCLS LIKE '%K' THEN 'UnKits'
--	WHEN SUBSTR(X.ITNBR,1,4)='100-' THEN 'CG'
--	WHEN SUBSTR(X.ITNBR,1,1) in ('A','B','D','E','H','L','P','Q','M','R','T','W','Z') THEN 'CG'
	ELSE 'UPH' END) as Product,
(CASE 
		WHEN X.TCODE IN ('RM') THEN 'IN'
		WHEN X.TCODE IN ('SA') THEN 'OUT'
		WHEN X.TCODE IN ('TW') THEN 'OUT'
		WHEN X.TCODE IN ('RW') THEN 'IN'
		ELSE 'CHECK' END ) as "TYPE",
(CASE 
    WHEN Y.RPAMVA IS NULL AND X.ITCLS NOT LIKE 'Z%' THEN 0
	WHEN Y.RPAMVA IS NULL AND X.ITCLS LIKE 'Z%' THEN X.TRQTY*150
	ELSE X.TRQTY*Y.RPAMVA END) as "AMT($USD)"	
FROM
(
SELECT T1.TCODE, T1.ITNBR, T1.HOUSE, T2.ITCLS, WEEK(DATE('20'||SUBSTR(CHAR(T1.UPDDT),2,2)||'-'||SUBSTR(CHAR(T1.UPDDT),4,2)||'-'||SUBSTR(CHAR(T1.UPDDT),6,2))) AS WEEK,
YEAR(DATE('20'||SUBSTR(CHAR(T1.UPDDT),2,2)||'-'||SUBSTR(CHAR(T1.UPDDT),4,2)||'-'||SUBSTR(CHAR(T1.UPDDT),6,2))) AS YEAR,
SUM(T1.TRQTY) TRQTY
FROM AMFLIBW.IMHIST T1, AMFLIBW.ITMRVA T2, AMFLIBW.WHSMST T3
WHERE T2.ITNBR = T1.ITNBR AND T2.STID = T3.STID AND T1.HOUSE = T3.WHID AND T1.HOUSE='35' AND T2.ITCLS LIKE 'Z%' AND T2.ITCLS NOT LIKE '%K' AND T1.ITNBR NOT LIKE 'A%' 
AND T1.UPDDT BETWEEN CHAR('1'||VARCHAR_FORMAT(current date - 395 Days,'YYMMDD')) AND CHAR('1'||VARCHAR_FORMAT(current date,'YYMMDD'))
AND T1.TRQTY<>0 AND (T1.TCODE IN ('RM','SA','TW') OR (T1.TCODE IN ('RW') AND T1.ORDNO = ''))
GROUP BY T1.TCODE, T1.ITNBR, T1.HOUSE, T2.ITCLS,WEEK(DATE('20'||SUBSTR(CHAR(T1.UPDDT),2,2)||'-'||SUBSTR(CHAR(T1.UPDDT),4,2)||'-'||SUBSTR(CHAR(T1.UPDDT),6,2))),
YEAR(DATE('20'||SUBSTR(CHAR(T1.UPDDT),2,2)||'-'||SUBSTR(CHAR(T1.UPDDT),4,2)||'-'||SUBSTR(CHAR(T1.UPDDT),6,2)))
ORDER BY T1.ITNBR 
) AS X 
LEFT JOIN 
--GET UP
(SELECT a.RPAITX,(CASE WHEN a.RPBRCD IN ('VND') THEN a.RPAMVA/22685 ELSE a.RPAMVA END) AS RPAMVA,a.RPBLDT,a.RPZ0D7, T2.ITCLS
FROM AMFLIBW.ITMFPR a 
left join AMFLIBW.ITMRVA T2 on a.RPAITX=T2.ITNBR and a.RPZ0D7 = T2.STID 
WHERE a.RPZ0D7 = '35' AND a.RPAITX||a.RPZ0D7||a.RPBLDT IN 
(SELECT a.RPAITX||a.RPZ0D7||MAX(a.RPBLDT) RPBLDT
FROM AMFLIBW.ITMFPR a  WHERE a.RPZ0D7 = '35' GROUP BY a.RPAITX,a.RPZ0D7)
AND T2.ITCLS LIKE 'Z%') as Y 
ON X.ITNBR = Y.RPAITX
) AS a
GROUP BY a.HOUSE, a.Week, a.YEAR, a.Product, a.TYPE
ORDER BY a.YEAR,a.Week,a.Product

--AND (T1.TCODE IN ('RW') AND T1.ORDNO = '')

-- ON HAND IN WHSE35 ON DSN=WANEKBIB
SELECT a.ITNBR,a.HOUSE, a.ITCLS, a.MOHTQ, b.RPAMVA "UP($USD)",
(CASE 
    WHEN a.ITCLS NOT LIKE 'Z%' THEN 'RP'
	WHEN a.ITCLS LIKE 'Z%' AND a.ITCLS LIKE '%K' THEN 'UnKits'
--	WHEN SUBSTR(a.ITNBR,1,4)='100-' THEN 'CG'
--	WHEN SUBSTR(a.ITNBR,1,1) in ('A','B','D','E','H','L','P','Q','M','R','T','W','Z') THEN 'CG'
	ELSE 'UPH' END) as Product,
(CASE 
    WHEN b.RPAMVA IS NULL AND a.ITCLS NOT LIKE 'Z%' THEN 0
	WHEN b.RPAMVA IS NULL AND a.ITCLS LIKE 'Z%' THEN a.MOHTQ*150
	ELSE a.MOHTQ*b.RPAMVA END) as "AMT($USD)"
FROM 
(SELECT T1.ITNBR,T1.HOUSE, T1.ITCLS, T1.MOHTQ, T1.WHSLC, T2.ITDSC    
FROM AMFLIBW.ITEMBL T1, AMFLIBW.ITMRVA T2, AMFLIBW.WHSMST T3 
WHERE  T2.ITCLS = T1.ITCLS AND T2.ITNBR = T1.ITNBR AND T2.STID = T3.STID AND T1.HOUSE = T3.WHID AND ((T1.HOUSE='35') AND (T1.MOHTQ<>0))
AND T2.ITCLS LIKE 'Z%' AND T2.ITCLS NOT LIKE '%K'
ORDER BY T1.ITNBR) as a
LEFT JOIN 
--get UP
(SELECT a.RPAITX,(CASE WHEN a.RPBRCD IN ('VND') THEN a.RPAMVA/22685 ELSE a.RPAMVA END) AS RPAMVA,a.RPBLDT,a.RPZ0D7, T2.ITCLS
FROM AMFLIBW.ITMFPR a 
left join AMFLIBW.ITMRVA T2 on a.RPAITX=T2.ITNBR and a.RPZ0D7 = T2.STID 
WHERE a.RPZ0D7 = '35' AND a.RPAITX||a.RPZ0D7||a.RPBLDT IN 
(SELECT a.RPAITX||a.RPZ0D7||MAX(a.RPBLDT) RPBLDT
FROM AMFLIBW.ITMFPR a  WHERE a.RPZ0D7 = '35' GROUP BY a.RPAITX,a.RPZ0D7)
AND T2.ITCLS LIKE 'Z%') as b 
ON a.ITNBR = b.RPAITX



